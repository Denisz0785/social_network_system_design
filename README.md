## System Design социальной сети для курса по [System Design](https://balun.courses/courses/system_design)
Проектирование социальной сети для путешественников

### Функциональные требования:

1. Посты
   
   - Пользователь может создать пост с 1-5 фотографиями, текстом до 300 символов и привязкой к месту.
     
2. Комментарии
   
   - Пользователь может оставлять комментарии к постам. Максимальная длина комментария - 300 символов.
     
3. Лайки и дизлайки
   
   - Пользователь может поставить лайк или дизлайк на пост (только один на пост).
     
4. Подписки
   
   - Пользователь может подписываться на других пользователей и отменять подписку.
   - Лимит подписок: 10 000.
     
5. Поиск популярных мест
   
   - Пользователь может искать популярные места по названию (максимальная длина запроса - 100 символов).
    
6. Просмотр постов с конкретного места
   
   - Пользователь может просматривать посты из выбранного места.
   
7. Лента постов
   
   - Пользователь может просматривать ленту своих подписок в обратном хронологическом порядке.
   - Пользователь может просматривать ленту другого путешественника.
   
### Нефункциональные требования:

1. Производительность

   - Максимальная задержка при загрузке ленты: 3000 мс.
   - Максимальная задержка при отображении списка постов по месту: 3000 мс.
   - Максимальная задержка при поиске популярных мест: 3000 мс.
   - Максимальная задержка при загрузке поста - 2000мс.

2. Отказоустойчивость

   - Для защиты от отказов БД должна быть предусмотрена система резервного копирования данных или репликация БД.
   
3. Масштабируемость

   - Система должна поддерживать горизонтальное масштабирование для работы с возрастающим числом пользователей.
   - Чтение и запись данных должны быть распределены на разные базы (например, разделение на базы для чтения и записи),тк количество операций чтения значительно преобладает над операциями записи
   - Для поиска и отображения популярных мест и постов система должна поддерживать индексацию данных или кэширования для ускорения поиска.

4. Доступность

   - Требуемая доступность системы: 99,95%.
      
5. Прочее
   - 10 000 000 DAU
   - Геораспределение не требуется, тк приложение действует только в СНГ
   - Данные должны храниться всегда
   - Система должна поддерживать работу на мобильных устройствах и в браузере, обеспечивая удобный интерфейс для пользователей.
   - В сезон отпусков и праздников нагрузка на сервис может увеличиваться в 3-5 раз. более крупные:
       - летние отпуска, майские праздники: апрель - середина сентября
       - нг праздники: ноябрь - середина января
   

### Примерный размер данных:

    - Пост: 300 байт (текст на 300 символов) + 2500 КБ (5 фото) + 100 байт (идентификатор места) ~= 2,5мб.
 
    - Комментарий: 300 байт (текст на 300 символов).

    - Лайк/Дизлайк: идентификатор пользователя и поста — 2 * 4 байта = 8 байт
  
    - Подписка: идентификатор пользователя и подписки — 2 * 4 байта = 8 байт
  
    - Поиск: 200 байт (запрос не более 200 символов) + 100 байт на каждый пост/место

### Оценка нагрузки:

Рассчеты исходя из того, что ежедневно в сервисе активно 10% пользователей

#### Запись данных:

1. Посты:
``` 
Каждый активный пользователь создает 1 пост/день
rps: 1 000 000 постов/день или 1 000 000 / 86 400 = 12 rps
traffic: 12 (rps) * 2,5мб ~= 30мб/c
```

2. Комментарии:
``` 
Каждый активный пользователь в среднем делает 10 комментариев/день
rps: 1 000 000 * 10 = 10 000 000/день или 10 000 000 / 86400 = 120rps
traffic: 10 млн * 300 байт ~= 3 ГБ/день или 3гб/ 86400 = ~35кб/с
```

3. Лайки/Дизлайки:
```
Каждый активный пользователь в среднем ставит 30 лайков/день
rps: 1 000 000 * 30 = 30 00 000/день или 30 000 000 / 86400 ~= 350rps
traffic: 350 * 8 байт ~= 3кб/c 
```

4. Подписки:
``` 
Каждый активный пользователь в среднем делает 10 подписок/день
rps: 1 000 000 * 10 = 10 млн подписок в день или 10 000 000 / 86400 ~= 115rps
traffic: 115 * 8 байт ~= 920 байт/с
```

#### Чтение данных:

1. Лента:
```
Каждый активный пользователь просматривает 5 лент, в каждой ленте 10 постов.  
rps: 1 000 000 * 5 = 5 000 000 лент/день или 5 000 000 / 86400 ~= 58 rps  
traffic for media: 58 * (10 * 2,5 МБ) = 1450 МБ/с ~= 1,4ГБ/с
traffic for description of posts(текст поста + указатель на место): 58 * 10 * (300байт(текст) + 100байт(идентификатор места)) = 580 * 400байт ~= 230КБ/с 
```

2. Просмотр постов:
```
Каждый активный пользователь просматривает 20 постов/день.  
rps: 1 000 000 * 20 = 20 000 000/день или 20 000 000 / 86400 ~= 231 rps  
traffic for media: 231 * 2,5 МБ ~= 578 МБ/с
traffic for description of posts(текст поста + указатель на место): 231 * (300байт(текст) + 100байт(идентификатор места)) =  231 * 400байт ~= 92КБ/c 
```

3. Комментарии:
```
Каждый активный пользователь просматривает 20 постов, у каждого поста в среднем 50 комментариев.  
rps: 1 000 000 * (20 * 50) / 86400 ~= 11 574 rps  
traffic: 11 574 * 300 байт ~= 3,5 МБ/с  
```

4. Поиск мест:
```
Каждый активный пользователь делает 5 поисковых запросов по местам/день.  
rps: 1 000 000 * 5 = 5 000 000/день или 5 000 000 / 86400 ~= 58 rps  
traffic: 58 * 1кб(размер ответа на запрос) ~= 58 КБ/с
```

#### Оценка дисков:

Capacity:
```
- посты-медиа: 1 000 000 (постов) * 365 * 2,5мб = 912500000мб = 912500ГБ ~= 913ТБ
- посты-метаинфо: 1 000 000 (постов) * 365 * 400байт = 146000000000байт = 146гб
- комментарии: 1 000 000 * 10 (комментов/день) * 365 * 300байт = 1095000МБ = 1095ГБ ~= 1ТБ
- лайки: 1 000 000 * 30 (лайков/день) * 365 * 8 = 87600000000байт = 87600мб ~= 88ГБ
- подписки: 1 000 000 * 10 (подсписок/день) * 365 * 8 ~= 29ГБ
```
Disks_for_capacity:
```
- подсистема Постов-медиа(HDD 8ТБ) = 914ТБ/8 = 115
- подсистема Постов-метаинфо (HDD 256ГБ) = 146/256 = 1 (с запасом)
- подсистема Комментариев (HDD 2TB)= 1ТБ/2 = 1 (с запасом)
- подсистема Лайков (HDD 256ГБ) = 88ГБ/256 = 1 (с запасом)
- подсистема Подписок (HDD 128ГБ) = 29ГБ/128 = 1 (с запасом)
```
Disks_for_throughput:
```
- подсистема Постов-медиа = (30мб/c + 1,4ГБ/c + + 578мб/c)/ 100 ~= 20
- подсистема Постов-метаинфо = (5кб/c + + 230кб/c + 92кб/c) / 100 ~= 1
- подсистема Комментариев = (36кб/c + + 3,5мб/c)/ 100 = ~= 1
- подсистема Лайков = (3кб/c + 2кб/c) / 100 ~= 1
- подсистема Подписок = (920байт / 100) ~= 1
```
Disks_for_iops:
```
- подсистема Постов = 12+58+231 = 301 / 100 ~= 4
- подсистема Комментариев = 120 +11574 = 11694 / 100 ~= 117
- подсистема Лайков = 350 + 231 + 58 = 639 / 100 ~= 7
- подсистема Подписок = 115 / 100 ~= 1   
```
Итого Disks:
```
- подсистема Постов-медиа = 115 (HDD 8TB)
- подсистема Постов-метаинфо = 1 (HDD 256ГБ)
- подсистема Комментариев = 117 (HDD 16ГБ)
- подсистема Лайков = 7 (HDD 16ГБ)
- подсистема Подписок = 1 (HDD 128ГБ)
```

#### Планирую использовать PostgreSQL (тк больше экспертизы в ней) и blob storage Minio S3 (для хранения фото)

#### Репликация:
```
    - RF 2-3 (в зависимости от денежных средств)
    - вид репликации: 
        - async (системе не требуется строгая согласованность(в условиях задания нет функцион.требований о фин.операциях), больше предпочтение доступности)
        - push (PostgreSQL)
        - master-slave (наиболее простой в реализации, нет необходимости усложнять)
        - физическая
```
#### Шардирование: 
```
   - способ шардирования: Range based (нет потребности хранить все данные по пользователю отдельно, тк пользователи могут просматривать совместно одну и ту же инфо, и инфо друг о друге )
```

#### Кол-во хостов отдельно для подсистем:

- **по постам-медиа:**
  - Disks_for_capacity(HDD 8TB) = 913TB/8 ~= 115
  - Disks_for_throughput ~= 20  
  - Disks_for_iops = 4
  - Host = 115 / 2 = 58 hosts with 2 disk
  - Hosts_with_replication = 58 шардов * 2(RF) = 116
  
- **по постам-метаинфо:**
  - Disks_for_capacity(HDD 256ГБ) = 146GB/256GB ~= 1
  - Disks_for_throughput ~= 1  
  - Disks_for_iops = 1
  - Host = 1 / 2 = 1 hosts with 1 disk
  - Hosts_with_replication = 1 шардов * 2(RF) = 2
  - Шардирование не нужно, тк достаточно одного хоста  

- **по комментариям:**
  - Disks_for_capacity(HDD 2TB) = 1TB/2TB ~= 1
  - Disks_for_throughput ~= 1  
  - Disks_for_iops = 117
  - Host = 117 / 2 = 59 hosts with 2 disk
  - Hosts_with_replication = 59 шардов * 2(RF) = 118
  - тк 99% хостов необходимы для чтения, то кол-во хостов нужно в 2 раза меньше(при RF 2), тк часть нагрузки будет распределяться на реплики: 118 / 2 = 59 шардов  

- **по лайкам:** 
  - Disks_for_capacity(HDD 256GB) = 88GB/256 ~= 1
  - Disks_for_throughput ~= 1  
  - Disks_for_iops = 7
  - Host = 7 / 2 = 4 hosts with 2 disk
  - Hosts_with_replication = 4 шарда * 2(RF) = 8
  - тк 99% хостов необходимы для чтения, то кол-во хостов нужно в 2 раза меньше(при RF 2), тк часть нагрузки будет распределяться на реплики: 8 / 2 = 4  
  
- **по подпискам:** 
  - Disks_for_capacity(HDD 128GB) = 29GB/128 ~= 1
  - Disks_for_throughput = 920byte/2GB ~= 1  
  - Disks_for_iops = 115/100 = 2
  - Host = 2 / 2 = 1 host with 2 disk
  - Hosts_with_replication 1 * 2(RF) = 2  
  - Шардирование не нужно, тк достаточно одного хоста  
 
